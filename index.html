<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ì‹¤ì‹œê°„ ë²„íŠ¼ ì¹´ìš´íŠ¸</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
</head>
<body>
<button id="connectBtn">ì•„ë‘ì´ë…¸ ì—°ê²°</button>
<canvas id="barChart" width="600" height="400"></canvas>

<script>
// ğŸ§­ ì˜¤ëŠ˜ ë‚ ì§œë¥¼ '2025-10-16' í˜•ì‹ìœ¼ë¡œ ë°˜í™˜
function getTodayKey() {
    const d = new Date();
    return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`;
}

let port;
let reader;

// âœ… ë¡œì»¬ ì €ì¥ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
let savedCounts = JSON.parse(localStorage.getItem("buttonCounts"));
let savedDate = localStorage.getItem("savedDate");
let today = getTodayKey();

// ë‚ ì§œê°€ ê°™ìœ¼ë©´ ê¸°ì¡´ ë°ì´í„° ìœ ì§€, ë‹¤ë¥´ë©´ ì´ˆê¸°í™”
let counts = (savedCounts && savedDate === today) ? savedCounts : [0,0,0,0,0];

// ğŸ¨ Chart.js ì´ˆê¸°í™”
const ctx = document.getElementById('barChart').getContext('2d');
const data = {
    labels: ['ë§¤ìš° ë§Œì¡±', 'ë§Œì¡±', 'ë³´í†µ', 'ë¶ˆë§Œì¡±', 'ë§¤ìš° ë¶ˆë§Œì¡±'],
    datasets: [{
        label: 'ì¹´ìš´íŠ¸',
        data: counts,
        backgroundColor: ['#28a745', '#20c997', '#ffc107', '#007bff', '#dc3545']
    }]
};

const barChart = new Chart(ctx, {
    type: 'bar',
    data: data,
    options: { 
        animation: false,
        plugins: {
            legend: { display: false },
            datalabels: {
                color: 'black',
                anchor: 'end',
                align: 'start',
                font: { weight: 'bold', size: 14 },
                formatter: (value) => value
            }
        },
        scales: { 
            y: { 
                beginAtZero: true,
                suggestedMax: 100,
                ticks: { stepSize: 10 }
            }
        }
    },
    plugins: [ChartDataLabels]
});

// ğŸ§© ì•„ë‘ì´ë…¸ ì—°ê²° ë²„íŠ¼
document.getElementById('connectBtn').addEventListener('click', async () => {
    try {
        port = await navigator.serial.requestPort();
        await port.open({ baudRate: 9600 });
        reader = port.readable.getReader();
        readLoop();
    } catch (err) {
        console.error("ì—°ê²° ì‹¤íŒ¨:", err);
    }
});

// ğŸ”„ ì‹¤ì‹œê°„ ë°ì´í„° ì½ê¸°
async function readLoop() {
    let buffer = '';
    while (true) {
        const { value, done } = await reader.read();
        if (done) break;
        buffer += new TextDecoder().decode(value);
        let lines = buffer.split('\n');
        buffer = lines.pop();
        for (let line of lines) {
            const newCounts = line.trim().split(',').map(Number);
            if (newCounts.length === 5) {
                const now = getTodayKey();

                // âœ… ë‚ ì§œê°€ ë°”ë€Œë©´ ìë™ ì´ˆê¸°í™”
                if (now !== today) {
                    counts = [0,0,0,0,0];
                    today = now;
                } else {
                    counts = newCounts;
                }

                // âœ… ì €ì¥
                localStorage.setItem("buttonCounts", JSON.stringify(counts));
                localStorage.setItem("savedDate", today);

                // âœ… ê·¸ë˜í”„ ì—…ë°ì´íŠ¸
                barChart.data.datasets[0].data = counts;
                barChart.update();
            }
        }
    }
}
</script>
</body>
</html>

