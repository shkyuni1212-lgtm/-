<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>실시간 버튼 카운트</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
</head>
<body>

<button id="connectBtn">아두이노 연결</button>
<select id="dateSelect"></select>
<canvas id="barChart" width="600" height="400"></canvas>

<script>
// 오늘 날짜 반환
function getTodayKey() {
    const d = new Date();
    return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`;
}

// 날짜별 저장 불러오기
let allCounts = JSON.parse(localStorage.getItem("allButtonCounts")) || {};
let today = getTodayKey();
let counts = allCounts[today] || [0,0,0,0,0];

// Chart.js 초기화
const ctx = document.getElementById('barChart').getContext('2d');
const data = {
    labels: ['매우 만족', '만족', '보통', '불만족', '매우 불만족'],
    datasets: [{
        label: '카운트',
        data: counts,
        backgroundColor: ['#28a745', '#20c997', '#ffc107', '#007bff', '#dc3545']
    }]
};

const barChart = new Chart(ctx, {
    type: 'bar',
    data: data,
    options: { 
        animation: false,
        plugins: {
            legend: { display: false },
            datalabels: {
                color: 'black',
                anchor: 'end',
                align: 'start',
                font: { weight: 'bold', size: 14 },
                formatter: (value) => value
            }
        },
        scales: { 
            y: { beginAtZero: true, suggestedMax: 100, ticks: { stepSize: 10 } }
        }
    },
    plugins: [ChartDataLabels]
});

// 날짜 선택 드롭다운
const dateSelect = document.getElementById('dateSelect');
function updateDateSelect() {
    dateSelect.innerHTML = '';
    Object.keys(allCounts).sort().forEach(date => {
        const option = document.createElement('option');
        option.value = date;
        option.textContent = date;
        if (date === today) option.selected = true;
        dateSelect.appendChild(option);
    });
}
updateDateSelect();

// 선택한 날짜 상태
let selectedDate = today;

// 날짜 선택 시 그래프 변경
dateSelect.addEventListener('change', () => {
    selectedDate = dateSelect.value;
    barChart.data.datasets[0].data = allCounts[selectedDate] || [0,0,0,0,0];
    barChart.update();
});

// 아두이노 연결
let port;
let reader;
document.getElementById('connectBtn').addEventListener('click', async () => {
    try {
        port = await navigator.serial.requestPort();
        await port.open({ baudRate: 9600 });
        reader = port.readable.getReader();
        readLoop();
    } catch (err) {
        console.error("연결 실패:", err);
    }
});

// 실시간 데이터 읽기
async function readLoop() {
    let buffer = '';
    while (true) {
        const { value, done } = await reader.read();
        if (done) break;
        buffer += new TextDecoder().decode(value);
        let lines = buffer.split('\n');
        buffer = lines.pop();
        for (let line of lines) {
            const newCounts = line.trim().split(',').map(Number);
            if (newCounts.length === 5) {
                const now = getTodayKey();
                if (now !== today) counts = [0,0,0,0,0];
                counts = newCounts;

                // 날짜별 저장
                today = now;
                allCounts[today] = counts;
                localStorage.setItem("allButtonCounts", JSON.stringify(allCounts));

                // 드롭다운 갱신
                updateDateSelect();

                // 오늘 선택되어 있을 때만 그래프 업데이트
                if (selectedDate === today) {
                    barChart.data.datasets[0].data = counts;
                    barChart.update();
                }
            }
        }
    }
}
</script>
</body>
</html>
