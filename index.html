<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ì‹¤ì‹œê°„ ë²„íŠ¼ ì¹´ìš´íŠ¸</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
</head>
<body>

<button id="connectBtn">ì•„ë‘ì´ë…¸ ì—°ê²°</button>
<select id="dateSelect"></select>
<button id="exportBtn">CSV ë‚´ë³´ë‚´ê¸°</button>
<input type="file" id="importFile" accept=".csv" style="display:none;">
<button id="importBtn">CSV ë¶ˆëŸ¬ì˜¤ê¸°</button>

<canvas id="barChart" width="600" height="400"></canvas>

<script>
// ğŸ—“ ì˜¤ëŠ˜ ë‚ ì§œ êµ¬í•˜ê¸°
function getTodayKey() {
    const d = new Date();
    return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`;
}

// ğŸ“¦ localStorage ë¶ˆëŸ¬ì˜¤ê¸°
let allCounts = JSON.parse(localStorage.getItem("allButtonCounts")) || {};
let today = getTodayKey();
let counts = allCounts[today] || [0,0,0,0,0];

// ğŸ¨ Chart.js ê·¸ë˜í”„ ì´ˆê¸°í™”
const ctx = document.getElementById('barChart').getContext('2d');
const data = {
    labels: ['ë§¤ìš° ë§Œì¡±', 'ë§Œì¡±', 'ë³´í†µ', 'ë¶ˆë§Œì¡±', 'ë§¤ìš° ë¶ˆë§Œì¡±'],
    datasets: [{
        label: 'ì¹´ìš´íŠ¸',
        data: counts,
        backgroundColor: ['#28a745', '#20c997', '#ffc107', '#007bff', '#dc3545']
    }]
};

const barChart = new Chart(ctx, {
    type: 'bar',
    data: data,
    options: { 
        animation: false,
        plugins: {
            legend: { display: false },
            datalabels: {
                color: 'black',
                anchor: 'end',
                align: 'start',
                font: { weight: 'bold', size: 14 },
                formatter: (value) => value
            }
        },
        scales: { 
            y: { beginAtZero: true, suggestedMax: 100, ticks: { stepSize: 10 } }
        }
    },
    plugins: [ChartDataLabels]
});

// ğŸ“… ë‚ ì§œ ì„ íƒ ë“œë¡­ë‹¤ìš´
const dateSelect = document.getElementById('dateSelect');
function updateDateSelect() {
    dateSelect.innerHTML = '';
    Object.keys(allCounts).sort().forEach(date => {
        const option = document.createElement('option');
        option.value = date;
        option.textContent = date;
        if (date === today) option.selected = true;
        dateSelect.appendChild(option);
    });
}
updateDateSelect();

let selectedDate = today;
dateSelect.addEventListener('change', () => {
    selectedDate = dateSelect.value;
    barChart.data.datasets[0].data = allCounts[selectedDate] || [0,0,0,0,0];
    barChart.update();
});

// ğŸ”Œ ì•„ë‘ì´ë…¸ ì—°ê²°
let port;
let reader;
document.getElementById('connectBtn').addEventListener('click', async () => {
    try {
        port = await navigator.serial.requestPort();
        await port.open({ baudRate: 9600 });
        reader = port.readable.getReader();
        readLoop();
    } catch (err) {
        console.error("ì—°ê²° ì‹¤íŒ¨:", err);
    }
});

// ğŸ”„ ì‹¤ì‹œê°„ ë°ì´í„° ì½ê¸°
async function readLoop() {
    let buffer = '';
    while (true) {
        const { value, done } = await reader.read();
        if (done) break;
        buffer += new TextDecoder().decode(value);
        let lines = buffer.split('\n');
        buffer = lines.pop();
        for (let line of lines) {
            const newCounts = line.trim().split(',').map(Number);
            if (newCounts.length === 5) {
                const now = getTodayKey();
                if (now !== today) counts = [0,0,0,0,0];
                counts = newCounts;

                today = now;
                allCounts[today] = counts;
                localStorage.setItem("allButtonCounts", JSON.stringify(allCounts));
                updateDateSelect();

                if (selectedDate === today) {
                    barChart.data.datasets[0].data = counts;
                    barChart.update();
                }
            }
        }
    }
}

// ğŸ’¾ CSV ë‚´ë³´ë‚´ê¸°
document.getElementById('exportBtn').addEventListener('click', () => {
    let csv = "ë‚ ì§œ,ë§¤ìš°ë§Œì¡±,ë§Œì¡±,ë³´í†µ,ë¶ˆë§Œì¡±,ë§¤ìš°ë¶ˆë§Œì¡±\n";
    for (const [date, arr] of Object.entries(allCounts)) {
        csv += `${date},${arr.join(',')}\n`;
    }

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = "button_data.csv";
    a.click();

    URL.revokeObjectURL(url);
});

// ğŸ“‚ CSV ë¶ˆëŸ¬ì˜¤ê¸°
const importFile = document.getElementById('importFile');
document.getElementById('importBtn').addEventListener('click', () => importFile.click());

importFile.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (event) => {
        const lines = event.target.result.trim().split('\n');
        const newData = {};
        lines.slice(1).forEach(line => {
            const [date, ...nums] = line.split(',');
            newData[date] = nums.map(Number);
        });
        allCounts = newData;
        localStorage.setItem("allButtonCounts", JSON.stringify(allCounts));
        updateDateSelect();

        // ë¶ˆëŸ¬ì˜¨ ë°ì´í„° ì²« ë‚ ì§œë¡œ í‘œì‹œ
        const firstDate = Object.keys(allCounts)[0];
        selectedDate = firstDate;
        barChart.data.datasets[0].data = allCounts[firstDate];
        barChart.update();

        alert("CSV ë°ì´í„°ê°€ ë¶ˆëŸ¬ì™€ì¡ŒìŠµë‹ˆë‹¤!");
    };
    reader.readAsText(file);
});
</script>
</body>
</html>
